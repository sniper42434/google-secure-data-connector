#!/bin/bash
#
# Copyright 2009 Google Inc. All Rights Reserved.
# Author: rayc@google.com (Ray Colline)

set -e  # bail out on any errors

# Install Properties
PREFIX=__PREFIX__
ETCPREFIX=__ETCPREFIX__
VARPREFIX=__VARPREFIX__
BINPREFIX=${PREFIX}/bin
LIBPREFIX=${PREFIX}/lib

APACHE_CONF=${ETCPREFIX}/apache
SSH_CONF_DIR=${ETCPREFIX}/openssh
SSH_USER_DIR=${ETCPREFIX}/woodstock-user/.ssh
USER=__USER__
GROUP=__GROUP__
SSH_WOODSTOCK_USER=woodstock

TIMESTAMP=$(date +'%Y%m%d_%H%M%S')

# Check root.
if [ $(id -u) != 0 ]; then
  echo install must be run as user root.
  exit 1
fi

# Create directories
for dir in \
    "${PREFIX}" \
    "${LIBPREFIX}" \
    "${BINPREFIX}" \
    "${ETCPREFIX}" \
    "${VARPREFIX}" \
    "${VARPREFIX}/log" \
    "${SSH_CONF_DIR}" \
    "${SSH_USER_DIR}" \
    "${APACHE_CONF}" \
    "${APACHE_CONF}/htdocs"; do
  echo making dir ${dir}
  mkdir -p $dir
done

# binary
cp runclient.sh "${BINPREFIX}" 
chmod -R 755 ${BINPREFIX}

# lib
for jar in "agent.jar" "protocol.jar"; do
  echo installing ${jar} 
  install -m 644 build/${jar} ${LIBPREFIX}/${jar}
done

THIRD_PARTY_FILES=$(find third-party/ -type f | grep -v apache-httpd |grep -v .svn)
for file in ${THIRD_PARTY_FILES}; do
  echo installing ${file}
  install -m 644 -D ${file} ${LIBPREFIX}/${file}
done


# backup old config files
if [ -e ${ETCPREFIX}/localConfig.xml ]; then
  echo backing up old localConfig.xml file
  install ${ETCPREFIX}/localConfig.xml \
      ${ETCPREFIX}/localConfig.xml-existing-${TIMESTAMP}
fi

if [ -e ${ETCPREFIX}/resourceRules.xml ]; then
  echo backing up old resourceRules.xml file
  install ${ETCPREFIX}/resourceRules.xml \
      ${ETCPREFIX}/resourceRules.xml-existing-${TIMESTAMP}
fi

# localConfig.xml
file="${ETCPREFIX}/localConfig.xml"
echo installing ${file}
install -g ${GROUP} -o root -m 640 ./config/localConfig.xml ${file}

# resourceRules.xml-dist
file="${ETCPREFIX}/resourceRules.xml"
echo installing ${file}
install -g ${GROUP} -o root -m 640 ./config/resourceRules.xml-dist ${file}

# httpd.conf-template
file="${APACHE_CONF}/httpd.conf-template"
echo installing ${file}
install -g ${GROUP} -o ${USER} -m 640 \
    ./config/apache/httpd.conf-template ${file}

# mime.types 
file="${APACHE_CONF}/mime.types"
echo installing ${file}
install -g ${GROUP} -o ${USER} -m 640 ./config/apache/mime.types ${file}


### openssh  ###

# authorized_keys 
file="${SSH_USER_DIR}/authorized_keys"
echo installing ${file}
install -T -o ${USER} -m 600 "config/openssh/woodstock-authorized_keys" ${file}

# ssh host keys 
for file in "ssh_host_rsa_key" "ssh_host_dsa_key" "ssh_host_rsa_key.pub" \
    "ssh_host_dsa_key.pub"; do
  echo installing ${SSH_CONF_DIR}/${file}
  install -g ${GROUP} -o ${USER} -m 600 ./config/openssh/${file} \
      ${SSH_CONF_DIR}/${file}
done

# sshd_config
file="${SSH_CONF_DIR}/sshd_config"
echo installing ${file}
install -g ${GROUP} -o ${USER} -m 600 \
   "./config/openssh/sshd_config" ${file}

# start_sshd.sh 
file="${SSH_CONF_DIR}/start_sshd.sh"
echo installing ${file}
install -g ${GROUP} -o ${USER} -m 750 \
    "./config/openssh/start_sshd.sh" ${file}

# allow user to write out apache config files 
echo setting permissions on ${APACHE_CONF}
chgrp ${GROUP} ${APACHE_CONF}
chmod 770 "${APACHE_CONF}" 

# allow user to write out apache log files
echo setting permissions on ${VARPREFIX}/log
chgrp ${GROUP} "${VARPREFIX}/log"
chmod 770 "${VARPREFIX}/log"
