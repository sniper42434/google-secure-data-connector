#!/bin/bash
#
# Copyright 2008 Google Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# $Id$

set -e

# TODO: Much of this stuff could be more properly managed with real Debian
#       packaging.

LOGDIR=__LOGDIR__
RULES_DIR=__LOCALSTATEDIR__
SYSCONFDIR=__SYSCONFDIR__
USER=__USER__
GROUP=__GROUP__

if [ "$1" = "configure" ]; then
  # Set up the user to access the client
  adduser --system --quiet --group --home "/home/${USER}" --no-create-home \
   --shell /bin/bash "${USER}" || :

  if [ ! -d ${LOGDIR} ]; then
    mkdir -p ${LOGDIR}
  fi
  chown ${USER}:${GROUP} ${LOGDIR}
  chmod 770 "${LOGDIR}"
  for filename in "agent"; do
    logfile="${LOGDIR}/$filename"
    if [ ! -f "${logfile}" ]; then
      touch "${logfile}"
    fi
    chown ${USER}:${USER} "${logfile}"
    chmod 660 "${logfile}"
  done

  if [ ! -d "${SYSCONFDIR}" ]; then
    mkdir -vp "${SYSCONFDIR}"
  fi

  chown ${USER}:${GROUP} "${SYSCONFDIR}"

  chmod 750 "${SYSCONFDIR}"

  chown ${USER}:${GROUP} ${SYSCONFDIR}/localConfig.xml
  chown ${USER}:${GROUP} ${SYSCONFDIR}/resourceRules.xml
  chmod 0640 ${SYSCONFDIR}/localConfig.xml
  chmod 0640 ${SYSCONFDIR}/resourceRules.xml

  # Check for java
  echo "Checking for Java..."
  if [ ${JAVA_HOME} ]; then
    JAVABIN=${JAVA_HOME}/bin/java
  elif [ ${JAVAHOME} ]; then
    JAVABIN=${JAVAHOME}/bin/java
  else # Try to figure it out.
    JAVABIN=$(which java) >/dev/null 2>&1 || true
  fi

  if [ -x "${JAVABIN}" ]; then
    ${JAVABIN} -version 2>&1 | grep 'version' |grep -q '1.6'
    if [ $? != 0 ]; then
      echo "Java found at ${JAVABIN} might not suitable."
      echo "Secure Data Connector requires JRE 1.6 or higher"
      exit 1
    else
      echo "Found java at ${JAVABIN}"
    fi
  else
    echo "Java could not be found."
    echo "Please install Java JRE 1.6 or higher before using the Secure Data Connector."
    exit 1
  fi
fi

installinit_error() {
  exit $?
}