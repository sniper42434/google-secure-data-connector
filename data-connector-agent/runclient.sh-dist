#!/bin/bash
#
# * Copyright 2008 Google Inc.
# *
# * This program is free software; you can redistribute it and/or
# * modify it under the terms of the GNU General Public License
# * as published by the Free Software Foundation; either version 2
# * of the License, or (at your option) any later version.
# *
# * This program is distributed in the hope that it will be useful,
# * but WITHOUT ANY WARRANTY; without even the implied warranty of
# * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# * GNU General Public License for more details.
# *
# * You should have received a copy of the GNU General Public License
# * along with this program; if not, write to the Free Software
# * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
#
# Runs client with appropriate class path.

WOODSTOCK_HOME=_PREFIX_
WOODSTOCK_LIB=${WOODSTOCK_HOME}/lib
CONFIGFILE=_ETCPREFIX_/localConfig.xml
RULESFILE=_ETCPREFIX_/resourceRules.xml
JVM_ARGS="-Djava.net.preferIPv4Stack=true"

# Dynamically generate classpath from lib directory.
jarfiles=$(find ${WOODSTOCK_LIB} -type f -a -name \*.jar)
for jar in ${jarfiles}; do
  CLASSPATH=${CLASSPATH}:${jar}
done
export CLASSPATH

# Create flags for local config file.
OPTS=$(getopt -o f:r:j: --long localConfigFile::,rulesFile::,jvm_args:: -n 'runagent' -- "$@")
if [ $? != 0 ]; then
  echo -e "\nUsage:
    -f|--localConfigFile) Local configuration file
    -r|--rulesFile) Resource rules file.
    -j|--jvm-args) Override default jvmargs with these.
  " >&2
  exit 1
fi

# Parse command line
eval set -- "${OPTS}"  
while true; do
  case "$1" in
    -f|--localConfigFile) CONFIGFILE=$2; shift 2 ;;
    -r|--rulesFile) RULESFILE=$2; shift 2 ;;
    -j|--jvm-args) JVM_ARGS=$2; shift 2 ;;
    --) shift ; break ;;
    *) echo "Error!" ; exit 1 ;;
  esac
done
  
# Make sure we are the only one who can read any generated files.
umask 0077

while /bin/true; do
  _JAVABIN_ ${JVM_ARGS} com.google.dataconnector.client.Client \
    -localConfigFile "${CONFIGFILE}" \
    -rulesFile "${RULESFILE}"
  sleep 5
  echo "RECONNECTING..."
done
