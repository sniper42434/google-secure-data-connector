#!/bin/bash
#
# * Copyright 2008 Google Inc.
# *
# * This program is free software; you can redistribute it and/or
# * modify it under the terms of the GNU General Public License
# * as published by the Free Software Foundation; either version 2
# * of the License, or (at your option) any later version.
# *
# * This program is distributed in the hope that it will be useful,
# * but WITHOUT ANY WARRANTY; without even the implied warranty of
# * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# * GNU General Public License for more details.
# *
# * You should have received a copy of the GNU General Public License
# * along with this program; if not, write to the Free Software
# * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
#
# Runs client with appropriate class path.

WOODSTOCK_HOME=_PREFIX_
WOODSTOCK_LIB=${WOODSTOCK_HOME}/lib
ETCPREFIX=_ETCPREFIX_
CONFIGFILE=${ETCPREFIX}/localConfig.xml
RULESFILE=${ETCPREFIX}/resourceRules.xml
JVM_ARGS="-Djava.net.preferIPv4Stack=true"
GROUP=_GROUP_
USER=_USER_
DEBUG=""
NOVERIFY="false"
# Dynamically generate classpath from lib directory.
jarfiles=$(find ${WOODSTOCK_LIB} -type f -a -name \*.jar)
for jar in ${jarfiles}; do
  CLASSPATH=${CLASSPATH}:${jar}
done
export CLASSPATH

# Create flags for local config file.
OPTS=$(getopt -o dnf:r:j: --long debug,noverify,localConfigFile::,rulesFile::,jvm_args:: -n 'runagent' -- "$@")
if [ $? != 0 ]; then
  echo -e "\nUsage:
    -d|--debug) Place into debug mode
    -n|--noverify) Skip file permission checks.  
    -f|--localConfigFile) Local configuration file
    -r|--rulesFile) Resource rules file.
    -j|--jvm-args) Override default jvmargs with these.
  " >&2
  exit 1
fi

# Parse command line
eval set -- "${OPTS}"  
while true; do
  case "$1" in
    -d|--debug) DEBUG="--debug"; shift 1 ;;
    -n|--noverify) NOVERIFY="true"; shift 1 ;;
    -f|--localConfigFile) CONFIGFILE=$2; shift 2 ;;
    -r|--rulesFile) RULESFILE=$2; shift 2 ;;
    -j|--jvm-args) JVM_ARGS=$2; shift 2 ;;
    --) shift ; break ;;
    *) echo "Error!" ; exit 1 ;;
  esac
done
  
# Make sure we are the only one who can read any generated files.
umask 0077

# Check file permissions

# Checks to see if the file has the supplied permissions and ownership. 
# exits the script if its incorrect.
#
# $1 filename
# $2 owner
# $3 group
# $4 mode

function checkfile {

if [ ${NOVERIFY} = "false" ]; then 

  file=$1
  if [ -e ${file} ]; then
    filegroup=$(stat -c "%G" ${file})
    fileowner=$(stat -c "%U" ${file})
    filemode=$(stat -c "%a" ${file})

    if [ ${fileowner} != "$2" -o  \
        ${filegroup} != "$3" -o \
        ${filemode} != "$4" ]; then
      echo $file has incorrect permissions should be $2:$3 $4
      exit
    fi
  else 
    echo $file does not exist!
    exit
  fi
fi
}

if [ ${NOVERIFY} = "false" ]; then 
  # Check current file permissions and refuse to run if they arent correct.
  checkfile ${CONFIGFILE} root nonconf 640
  checkfile ${RULESFILE} root nonconf 640
  checkfile ${ETCPREFIX}/localConfig.xml root ${GROUP} 640
  checkfile ${ETCPREFIX}/resourceRules.xml root ${GROUP} 640
  checkfile ${ETCPREFIX}/apache root ${GROUP} 770
  checkfile ${ETCPREFIX}/apache/httpd.conf-template ${USER} ${GROUP} 640
  checkfile ${ETCPREFIX}/apache/mime.types ${USER} ${GROUP} 640
  checkfile ${ETCPREFIX}/openssh root root 755
  checkfile ${ETCPREFIX}/openssh/ssh_host_dsa_key ${USER} ${GROUP} 600
  checkfile ${ETCPREFIX}/openssh/ssh_host_dsa_key.pub ${USER} ${GROUP} 600
  checkfile ${ETCPREFIX}/openssh/ssh_host_rsa_key ${USER} ${GROUP} 600
  checkfile ${ETCPREFIX}/openssh/ssh_host_rsa_key.pub ${USER} ${GROUP} 600
  checkfile ${ETCPREFIX}/openssh/sshd_config ${USER} ${GROUP} 600
  checkfile ${ETCPREFIX}/openssh/start_sshd.sh ${USER} ${GROUP} 750
  checkfile ${ETCPREFIX}/woodstock-user/.ssh/authorized_keys ${USER} ${GROUP} 600
fi

while /bin/true; do
  su ${USER} -c "_JAVABIN_ ${JVM_ARGS} com.google.dataconnector.client.Client \
    ${DEBUG} \
    -localConfigFile \"${CONFIGFILE}\" \
    -rulesFile \"${RULESFILE}\""
  sleep 5
  echo "RECONNECTING..."
done
