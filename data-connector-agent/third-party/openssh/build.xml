<?xml version="1.0" encoding="UTF-8"?>

<project 
    name="openssh-tunnel-server" 
    default="copysshd"
    basedir=".">

  <property name="version" value="1.0"/>

  <!-- Define Directories. -->

  <property name="openssh_targz" value="dist/openssh-4.7p1.tar.gz" />
  <property name="sshd" value="src/openssh-4.7p1/sshd" />
  <property name="sshdwin" value="src/openssh-4.7p1/sshd.exe" />
  <property name="osrc" value="src" />
  <property name="sbin" value="sbin" />
  <property name="sshbin" value="bin" />
  <property name="openssh_src" value="src/openssh-4.7p1"/>

  <!-- common targets -->
  <target name="init">    
    <!-- setup environment -->
    <tstamp>
      <format property="timestamp" pattern="MMddyyyyhhmm"/>
    </tstamp>
    <mkdir dir="${sbin}"/>
    <mkdir dir="${osrc}"/>
    <mkdir dir="${sshbin}"/>
  </target>

  <target name="untar" depends="init">
    <untar 
        src="${openssh_targz}" 
        dest="${osrc}/"
        compression="gzip"/>
  </target>

  <target name="configure" depends="untar">
    <exec 
        dir="${openssh_src}"
        executable="sh">
      <arg value="configure"/>
      <arg value="--without-kerberos5"/>
      <arg value="--without-selinux"/>
      <arg value="--without-pam"/>
      <arg value="--without-sectok"/>
      <arg value="--without-xauth"/>
      <arg value="--without-4in6"/>
    </exec>
  </target>

  <target name="clean" description="Deletes all build files.">
    <delete dir="${sbin}" />
    <delete dir="${osrc}" />
    <delete dir="${sshbin}" />
    <delete dir="bin" />
    <delete file="etc/sshd_config"/>
  </target>

  <!-- Target for Linux. -->

  <target name="makessh" depends="clean,configure">
    <exec
        dir="${openssh_src}"
        executable="make">
      <arg value="sshd"/>
    </exec>
  </target>

  <target name="buildsshd" depends="check" unless="present">
    <echo message="openssh/sshd file doesn'exist..building it" />
    <ant dir="." target="makessh" />
    <copy file="${sshd}" todir="${sbin}"/>
    <chmod file="${sbin}/sshd" perm="755"/>
  </target>

  <target name="check">
    <available property="present" file="bin/start_sshd.sh" />
  </target>

  <target name="FileExists" depends="check" if="present">
    <echo message="openssh/bin/start_sshd.sh file exists. Not rebuilding it.." />
  </target>

  <target name="copysshd" depends="FileExists,buildsshd" />

  <!-- Target for Windows. -->

  <target name="makesshwin" depends="configure">
    <exec
        dir="${openssh_src}"
        executable="make">
      <arg value="sshd.exe"/>
    </exec>
  </target>

  <target name="copysshdwin" depends="makesshwin">
    <copy file="${sshdwin}" todir="${sbin}"/>
    <chmod file="${sbin}/sshd.exe" perm="755"/>
  </target>

</project>

