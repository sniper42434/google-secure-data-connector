#!/bin/bash
#
# * Copyright 2008 Google Inc.
# *
# * This program is free software; you can redistribute it and/or
# * modify it under the terms of the GNU General Public License
# * as published by the Free Software Foundation; either version 2
# * of the License, or (at your option) any later version.
# *
# * This program is distributed in the hope that it will be useful,
# * but WITHOUT ANY WARRANTY; without even the implied warranty of
# * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# * GNU General Public License for more details.
# *
# * You should have received a copy of the GNU General Public License
# * along with this program; if not, write to the Free Software
# * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.



echo "Checking sshd version for sshd_config directive exceptions..."

sshd_config=_SSHDCONF_
sshd_bin=_SSHD_
declare -i sshd_ver
declare -i sshd_UseDNS

sshd_UseDNS=37
sshd_UseTCPKeepAlive=38
sshd_CompressionDelayed=41

# Get sshd version and convert it to integer i.e version 3.6 = 36
sshd_ver=`$sshd_bin -v 2>&1 | grep -i openssh_ | awk -F _ '{ print $2 }' | awk -F . '{ print $1 substr($2,1,1) }  '`

if [ $sshd_ver = 0 ]; then
 echo "Could not determine sshd version number. You might need to edit your config_sshd file manually"
 echo "  If sshd version < 3.7 replace directive UseDNS with directive VerifyReverseMapping in sshd_config"
 echo "  If sshd version < 3.8 replace directive TCPKeepAlive with directive KeepAlive in sshd_config"
 echo "  If sshd version < 4.1 replace directive 'Compression delayed' with directive 'Compression yes'"
 exit 0
fi

#sshd 3.7 changed directive  VerifyReverseMapping to UseDNS
if [ $sshd_ver -lt $sshd_UseDNS ]; then
  # sed replace option UseDNS with option VerifyReverseMapping in sshd_config
  echo "Adjusting SSHD_Config for older sshd property: VerifyReverseMapping"
  sed -i ${sshd_config} -e 's^UseDNS^VerifyReverseMapping^'
fi

# sshd 3.8 changed directive KeepAlive to TCPKeepAlive
if [ $sshd_ver -lt $sshd_UseTCPKeepAlive ]; then
  echo "Adjusting SSHD_Config for older sshd property: KeepAlive"
  sed -i ${sshd_config} -e 's^TCPKeepAlive yes^KeepAlive yes^'
fi
# sshd 4.1 introduced new option Compression delayed
if [ $sshd_ver -lt $sshd_CompressionDelayed ]; then
  echo "Adjusting SSHD_Config for older sshd property: Compression yes"
  sed -i ${sshd_config} -e 's^Compression delayed^Compression yes^'
fi

echo "Complete..."
